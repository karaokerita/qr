<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý thanh toán Karaoke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .red { color: red; font-weight: bold; }
    .green { color: green; font-weight: bold; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>Danh sách phòng</h2>
  <table id="roomTable">
    <thead>
      <tr>
        <th>Phòng</th>
        <th>Số tiền</th>
        <th>Hành động</th>
        <th>Trạng thái</th>
        <th>Thời gian thanh toán</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwpqJ9xMu6bb7uMIkquX20Wd0ArKF2dCNTcw1qHSTT8_ImWJUagBv1m40GVgRkvELVP/exec";

function formatMoney(value) {
  if (!value || isNaN(value)) return "";
  return Number(value).toLocaleString("vi-VN"); // dùng dấu chấm ngăn cách
}

function formatDate(value) {
  if (!value) return "";
  let d = new Date(value);
  if (isNaN(d.getTime())) return ""; // nếu lỗi ngày
  return d.toLocaleString("vi-VN");
}

async function loadRooms() {
  const res = await fetch(`${API_URL}?action=getRooms`);
  const data = await res.json();
  const tbody = document.querySelector("#roomTable tbody");
  tbody.innerHTML = "";

  data.forEach(room => {
    const tr = document.createElement("tr");

    // Cột tên phòng
    const tdName = document.createElement("td");
    tdName.textContent = room.name;
    tr.appendChild(tdName);

    // Cột số tiền
    const tdAmount = document.createElement("td");
    const input = document.createElement("input");
    input.type = "text";
    input.value = formatMoney(room.amount);
    input.style.textAlign = "right";
    tdAmount.appendChild(input);
    tr.appendChild(tdAmount);

    // Cột hành động
    const tdAction = document.createElement("td");
    const btnUpdate = document.createElement("button");
    btnUpdate.textContent = "Cập nhật";
    btnUpdate.disabled = true;
    tdAction.appendChild(btnUpdate);

    const btnPaid = document.createElement("button");
    btnPaid.textContent = "Thanh toán";
    tdAction.appendChild(btnPaid);
    tr.appendChild(tdAction);

    // Cột trạng thái
    const tdStatus = document.createElement("td");
    tdStatus.textContent = room.status;
    tdStatus.className = (room.status === "Đã thanh toán") ? "green" : "red";
    tr.appendChild(tdStatus);

    // Cột thời gian thanh toán
    const tdTime = document.createElement("td");
    tdTime.textContent = formatDate(room.time);
    tr.appendChild(tdTime);

    // Xử lý nhập số tiền
    input.addEventListener("input", () => {
      btnUpdate.disabled = false;
      // bỏ dấu chấm để gửi về số
      let raw = input.value.replace(/\./g, "").replace(/,/g, "");
      input.value = raw ? formatMoney(raw) : "";
    });

    // Nút cập nhật
    btnUpdate.addEventListener("click", async () => {
      let raw = input.value.replace(/\./g, "").replace(/,/g, "");
      await fetch(`${API_URL}?action=updateAmount&room=${encodeURIComponent(room.name)}&amount=${raw}`);
      loadRooms(); // refresh lại
    });

    // Nút thanh toán
    btnPaid.addEventListener("click", async () => {
      await fetch(`${API_URL}?action=markPaid&room=${encodeURIComponent(room.name)}`);
      loadRooms(); // refresh lại
    });

    tbody.appendChild(tr);
  });
}

// Refresh mỗi 60 giây
setInterval(loadRooms, 60000);

// Load ngay lần đầu
loadRooms();
</script>
</body>
</html>
