function doGet(e) {
  var action = e.parameter.action;
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1");

  if (action === "getRooms") {
    var data = sheet.getDataRange().getValues();
    var result = [];

    for (var i = 1; i < data.length; i++) {
      result.push({
        name: data[i][0],                  // cột A: Tên phòng
        amount: data[i][1],                // cột B: Số tiền
        status: data[i][2],                // cột C: Trạng thái
        time: data[i][4] ? formatTime(data[i][4]) : ""  // cột E: Thời gian
      });
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  }

  if (action === "updateAmount") {
    var room = e.parameter.room;
    var amount = e.parameter.amount;
    var rows = sheet.getDataRange().getValues();
    for (var i = 1; i < rows.length; i++) {
      if (rows[i][0] == room) {
        sheet.getRange(i + 1, 2).setValue(amount); // cột B
        break;
      }
    }
    return ContentService.createTextOutput("OK");
  }

  if (action === "markPaid") {
    var room = e.parameter.room;
    var rows = sheet.getDataRange().getValues();
    for (var i = 1; i < rows.length; i++) {
      if (rows[i][0] == room) {
        sheet.getRange(i + 1, 3).setValue("Đã thanh toán"); // cột C
        sheet.getRange(i + 1, 5).setValue(new Date());      // cột E
        break;
      }
    }
    return ContentService.createTextOutput("OK");
  }
}

function formatTime(value) {
  return Utilities.formatDate(new Date(value), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm");
}
