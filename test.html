<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Thu ngân Karaoke Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; background: #f5f5f5; padding: 20px; }
h1 { text-align: center; color: blue; }
#currentTime { text-align:center; font-weight:bold; margin-top:-10px; color:#555; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
th, td { border:1px solid #ddd; padding:10px; text-align:center;}
th { background:#007bff; color:white; }
input[type="text"] { width:140px; padding:5px; text-align:right; }
button { padding:6px 10px; margin:2px; border:none; border-radius:4px; cursor:pointer; }
.update { background:#28a745; color:white; opacity:0.5; cursor:not-allowed; }
.update.enabled { opacity:1; cursor:pointer; }
.paid { background:#dc3545; color:white; }
.paid:disabled { background:#aaa; cursor:not-allowed; }
.open { background:#007bff; color:white; }
.open:disabled { background:#aaa; cursor:not-allowed; }
.status-unpaid { color:red; font-weight:bold; }
.status-paid { color:green; font-weight:bold; }
.highlight { background:#d4edda !important; transition: background 2s ease; }
</style>
</head>
<body>
<h1>THU NGÂN TEST <br>KARAOKE RITA</h1>
<p id="currentTime"></p>

<table>
<thead>
<tr>
<th>Phòng</th>
<th>Số tiền</th>
<th>Hành động</th>
<th>Trạng thái</th>
<th>Thời gian thanh toán</th>
</tr>
</thead>
<tbody id="roomTable"></tbody>
</table>

<script>
const API = "https://script.google.com/macros/s/AKfycbz5mmvzJlznD4fOE8aoj5wg5z73N1St4KiV9MuZIZyT8uwxugDvcIE05CaS8Vh2XklM/exec"; // Thay bằng URL Web App của bạn

function formatNumber(n){ return n?Number(n).toLocaleString("vi-VN"):""; }

async function api(action, data={}){
  const res = await fetch(API, {
    method: "POST",
    body: JSON.stringify({action, ...data})
  });
  return await res.json();
}

async function loadRooms(highlight=null){
  const data = await api("getRooms");
  const table = document.getElementById("roomTable");
  table.innerHTML = "";
  data.forEach(room=>{
    const roomId = encodeURIComponent(room.name);
    const paid = room.status==="Đã thanh toán";
    const tr = document.createElement("tr");
    tr.id="row-"+roomId;
    tr.innerHTML=`
      <td>${room.name}</td>
      <td><input type="text" id="amount-${roomId}" value="${formatNumber(room.amount)}"
        data-raw="${room.amount||0}" oninput="onAmountChange('${roomId}')"
        onkeypress="if(event.key==='Enter'){updateAmount('${roomId}')}"/>
      </td>
      <td>
        <button id="update-${roomId}" class="update" disabled onclick="updateAmount('${roomId}')">Cập nhật</button>
        <button id="paid-${roomId}" class="paid" ${paid?"disabled":""} onclick="markPaid('${roomId}')">Đã thanh toán</button>
        <button id="open-${roomId}" class="open" ${!paid?"disabled":""} onclick="markUnpaid('${roomId}')">Mở phòng</button>
      </td>
      <td id="status-${roomId}" class="${paid?'status-paid':'status-unpaid'}">${room.status||""}</td>
      <td id="time-${roomId}">${room.refTime||""}</td>
    `;
    table.appendChild(tr);
    if(highlight===roomId){ tr.classList.add("highlight"); setTimeout(()=>tr.classList.remove("highlight"),2000);}
  });
}

function onAmountChange(id){
  const input=document.getElementById("amount-"+id);
  const raw=input.value.replace(/\./g,"").replace(/,/g,"");
  input.dataset.raw=raw;
  input.value=raw?Number(raw).toLocaleString("vi-VN"):"";
  const btn=document.getElementById("update-"+id);
  btn.classList.add("enabled"); btn.disabled=false;
}

async function updateAmount(id){
  const input=document.getElementById("amount-"+id);
  await api("updateAmount",{room:decodeURIComponent(id), amount:input.dataset.raw});
  loadRooms(id);
}

async function markPaid(id){
  await api("markPaid",{room:decodeURIComponent(id)});
  loadRooms(id);
}

async function markUnpaid(id){
  await api("markUnpaid",{room:decodeURIComponent(id)});
  loadRooms(id);
}

function updateClock(){
  const now=new Date();
  const days=["Chủ Nhật","Thứ Hai","Thứ Ba","Thứ Tư","Thứ Năm","Thứ Sáu","Thứ Bảy"];
  const time=now.toLocaleTimeString("vi-VN",{hour12:false});
  const date=now.toLocaleDateString("vi-VN");
  const dayName=days[now.getDay()];
  document.getElementById("currentTime").innerText=`${time} - ${dayName}, ${date}`;
}
setInterval(updateClock,1000);
updateClock();
loadRooms();
setInterval(loadRooms,15000);
</script>
</body>
</html>
