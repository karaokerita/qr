<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Thu ngân Karaoke</title>
<style>
body { font-family: Arial; background: #f5f5f5; padding: 20px; }
table { border-collapse: collapse; width: 100%; background: white; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #4CAF50; color: white; }
input[type="text"] { width: 100px; text-align: right; }
button { margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
button:disabled { background: #ccc; cursor: not-allowed; }
.open-btn { background: #2196F3; color: white; }
.update-btn { background: #FF9800; color: white; }
.paid-btn { background: #4CAF50; color: white; }
.paid-btn.active { box-shadow: 0 0 10px #4CAF50; }
</style>
</head>
<body>
<h2>Thu ngân Karaoke</h2>
<table id="roomTable">
<thead>
<tr>
<th>Phòng</th>
<th>Số tiền</th>
<th>Trạng thái</th>
<th>Giờ thanh toán</th>
<th>Hành động</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwur_6_mUlTTjYb9SWu6ZlEM_XeanC0UDUZG_QBjy4RrNKpywmaMjLOSMTatXBe2Tmt/exec";

function formatAmountInput(input){
  let value = input.value.replace(/\./g,'');
  if(!isNaN(value) && value!=='') input.value = Number(value).toLocaleString('vi-VN');
}
window.formatAmountInput = formatAmountInput;

function enableUpdate(input){
  const tr=input.closest('tr');
  tr.querySelector('.update-btn').disabled=false;
}
window.enableUpdate = enableUpdate;

async function callAPI(params){
  try{
    const res = await fetch(`${API_URL}?${new URLSearchParams(params)}`);
    return await res.json();
  }catch(e){ console.error(e); alert('Lỗi API'); return null; }
}

async function loadData(){
  const res = await fetch(API_URL);
  const data = await res.json();
  renderTable(data);
}

function renderTable(data){
  const tbody = document.querySelector('#roomTable tbody');
  tbody.innerHTML = '';
  if(!data || data.length<=1){ tbody.innerHTML='<tr><td colspan="5">Không có dữ liệu</td></tr>'; return; }

  data.slice(1).forEach(row=>{
    const [room, amount, status, , time] = [row[0], row[1], row[2], row[3], row[4]];
    const tr = document.createElement('tr');
    const formattedAmount = amount ? Number(amount).toLocaleString('vi-VN') : '';
    const paidDisabled = (status==='Đã thanh toán');

    tr.innerHTML = `
      <td>${room}</td>
      <td><input type="text" value="${formattedAmount}" oninput="enableUpdate(this)" onblur="formatAmountInput(this)" /></td>
      <td>${status}</td>
      <td>${time || ''}</td>
      <td>
        <button class="open-btn" onclick="openRoom('${room}', this)" ${status==='Đã thanh toán'?'disabled':''}>Mở phòng</button>
        <button class="update-btn" onclick="updateRoom('${room}', this)" disabled>Cập nhật</button>
        <button class="paid-btn ${status==='Đã thanh toán'?'active':''}" onclick="setPaid('${room}', this)" ${paidDisabled?'disabled':''}>Đã thanh toán</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Nút Mở phòng
async function openRoom(room, btn){
  const tr = btn.closest('tr');
  btn.innerText='Đang mở...'; btn.disabled=true;
  await callAPI({action:'open', room});
  tr.querySelector('.update-btn').disabled=false;
  tr.querySelector('.paid-btn').disabled=false;
  loadData();
}

// Nút Cập nhật
async function updateRoom(room, btn){
  const tr = btn.closest('tr');
  const input = tr.querySelector('input');
  let amount = input.value.replace(/\./g,'');
  if(isNaN(amount) || amount==='') amount=0;
  btn.innerText='Đang cập nhật...'; btn.disabled=true;
  await callAPI({action:'update', room, amount});
  tr.querySelector('.open-btn').disabled=true;
  tr.querySelector('.paid-btn').disabled=false;
  loadData();
}

// Nút Đã thanh toán
async function setPaid(room, btn){
  btn.disabled=true;
  await callAPI({action:'paid', room});
  loadData();
}

window.onload = loadData;
</script>
</body>
</html>
