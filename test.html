<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thu ngân Karaoke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1 { text-align: center; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #333; color: #fff; }
    button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    .update-btn { background: #007bff; color: white; }
    .open-btn { background: #28a745; color: white; }
    .paid-btn { background: #dc3545; color: white; }
    .disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Thu ngân Karaoke</h1>
  <table id="roomTable">
    <thead>
      <tr>
        <th>Tên phòng</th>
        <th>Số tiền</th>
        <th>Trạng thái</th>
        <th>Thời gian</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwur_6_mUlTTjYb9SWu6ZlEM_XeanC0UDUZG_QBjy4RrNKpywmaMjLOSMTatXBe2Tmt/exec";

    async function loadRooms() {
      try {
        const res = await fetch(API_URL);
        const rooms = await res.json();

        const tbody = document.querySelector("#roomTable tbody");
        tbody.innerHTML = "";

        rooms.forEach(room => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${room.name || ""}</td>
            <td>${room.amount || 0}</td>
            <td>${room.status || ""}</td>
            <td>${room.refTime || ""}</td>
            <td>
              <button class="open-btn" id="open-${room.name}" onclick="openRoom('${room.name}')" ${room.status === 'Chưa thanh toán' ? 'disabled' : ''}>Mở phòng</button>
              <button class="paid-btn" id="paid-${room.name}" onclick="markPaid('${room.name}')" ${room.status === 'Chưa thanh toán' ? '' : 'disabled'}>Đã thanh toán</button>
              <button class="update-btn" onclick="updateRoom('${room.name}')">Cập nhật</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Lỗi loadRooms:", err);
      }
    }

    async function openRoom(name) {
      if (!name) return alert("Tên phòng không xác định!");
      const now = new Date().toLocaleString("vi-VN");
      await fetch(`${API_URL}?action=open&name=${encodeURIComponent(name)}&refTime=${encodeURIComponent(now)}`);
      loadRooms();
    }

    async function markPaid(name) {
      if (!name) return alert("Tên phòng không xác định!");
      await fetch(`${API_URL}?action=pay&name=${encodeURIComponent(name)}`);
      loadRooms();
    }

    async function updateRoom(name) {
      if (!name) return alert("Tên phòng không xác định!");
      await fetch(`${API_URL}?action=update&name=${encodeURIComponent(name)}`);
      loadRooms();
    }

    loadRooms();
  </script>
</body>
</html>
