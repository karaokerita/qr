<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thu ngân Karaoke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1 { text-align: center; color: #333; }
    #clock { text-align: center; font-size: 18px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    button { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-update { background: #2196F3; color: #fff; }
    .btn-paid { background: #4CAF50; color: #fff; }
    .btn-open { background: #FF9800; color: #fff; }
    input[type="number"] { width: 80px; padding: 5px; text-align: right; }
  </style>
</head>
<body>
  <h1>Thu ngân Karaoke</h1>
  <div id="clock"></div>
  <table>
    <thead>
      <tr>
        <th>Phòng</th>
        <th>Số tiền (VNĐ)</th>
        <th>Trạng thái</th>
        <th>Giờ thanh toán</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody id="roomTable"></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwwumEhSgb6kkUIYED9snXe8rM2vFSNLdQ6OYTgwkssC2cOJSf3dTW-P6YbIL-PNn0A/exec"; // thay bằng URL web app sau khi deploy

    // Đồng hồ
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").innerText = now.toLocaleString("vi-VN");
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Load dữ liệu từ Google Sheet
    async function loadData() {
      const res = await fetch(API_URL);
      const data = await res.json();

      const tbody = document.getElementById("roomTable");
      tbody.innerHTML = "";

      for (let i = 1; i < data.length; i++) {
        const [room, amount, status, reftime] = data[i];

        const tr = document.createElement("tr");

        // Cột phòng
        const tdRoom = document.createElement("td");
        tdRoom.textContent = room;
        tr.appendChild(tdRoom);

        // Cột số tiền
        const tdAmount = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.value = amount || "";
        tdAmount.appendChild(input);
        tr.appendChild(tdAmount);

        // Cột trạng thái
        const tdStatus = document.createElement("td");
        tdStatus.textContent = status;
        tr.appendChild(tdStatus);

        // Cột giờ thanh toán
        const tdTime = document.createElement("td");
        tdTime.textContent = reftime ? new Date(reftime).toLocaleTimeString("vi-VN") : "";
        tr.appendChild(tdTime);

        // Cột thao tác
        const tdActions = document.createElement("td");

        // Nút mở phòng
        const btnOpen = document.createElement("button");
        btnOpen.textContent = "Mở phòng";
        btnOpen.className = "btn-open";
        btnOpen.disabled = false;
        btnOpen.onclick = async () => {
          await fetch(API_URL + "?action=openRoom&room=" + encodeURIComponent(room));
          btnOpen.disabled = true;
          loadData();
        };
        tdActions.appendChild(btnOpen);

        // Nút cập nhật
        const btnUpdate = document.createElement("button");
        btnUpdate.textContent = "Cập nhật";
        btnUpdate.className = "btn-update";
        btnUpdate.onclick = async () => {
          const value = input.value || 0;
          await fetch(API_URL + "?action=updateAmount&room=" + encodeURIComponent(room) + "&amount=" + value);
          loadData();
        };
        tdActions.appendChild(btnUpdate);

        // Nút đã thanh toán
        const btnPaid = document.createElement("button");
        btnPaid.textContent = "Đã thanh toán";
        btnPaid.className = "btn-paid";
        btnPaid.onclick = async () => {
          await fetch(API_URL + "?action=markPaid&room=" + encodeURIComponent(room));
          loadData();
        };
        tdActions.appendChild(btnPaid);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      }
    }

    // Refresh mỗi 15s
    setInterval(loadData, 15000);
    loadData();
  </script>
</body>
</html>
