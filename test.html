<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Thu ngân Karaoke</title>
<style>
body { font-family: Arial; background: #f5f5f5; padding: 20px; }
table { border-collapse: collapse; width: 100%; background: white; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #4CAF50; color: white; }
input[type="text"] { width: 100px; text-align: right; }
.text-red { color: red; font-weight: bold; }
.text-green { color: green; font-weight: bold; }
.text-blue { color: blue; font-weight: bold; }
button { margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
button:disabled { background: #ccc; cursor: not-allowed; }
.open-btn { background: #2196F3; color: white; }
.update-btn { background: #FF9800; color: white; }
.paid-btn { background: #4CAF50; color: white; }
</style>
</head>
<body>
<h2>Thu ngân Karaoke</h2>
<table id="roomTable">
<thead>
<tr>
<th>Phòng</th>
<th>Số tiền</th>
<th>Trạng thái</th>
<th>Giờ thanh toán</th>
<th>Hành động</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwur_6_mUlTTjYb9SWu6ZlEM_XeanC0UDUZG_QBjy4RrNKpywmaMjLOSMTatXBe2Tmt/exec";

// Format số tiền
function formatAmountInput(input) {
  let value = input.value.replace(/\./g,'');
  if(!isNaN(value)&&value!==''){
    input.value = Number(value).toLocaleString('vi-VN');
  }
}
window.formatAmountInput = formatAmountInput;

// Bật nút cập nhật khi sửa
function enableUpdate(input){
  const tr=input.closest("tr");
  const updateBtn=tr.querySelector(".update-btn");
  updateBtn.disabled=false;
}
window.enableUpdate=enableUpdate;

// Gọi API
async function callAPI(params){
  try{
    const res=await fetch(`${API_URL}?${new URLSearchParams(params)}`);
    return await res.json();
  }catch(e){
    alert("Lỗi API");
    console.error(e);
    return null;
  }
}

// Mở phòng
async function openRoom(room, btn){
  const oldText = btn.innerText;
  btn.innerText = "Đang mở..."; 
  btn.disabled = true;

  await callAPI({action:'open', room}); // ghi sheet trạng thái "Chưa thanh toán"
  btn.innerText = oldText;
  btn.disabled = false;
  loadData();
}
window.openRoom = openRoom;

// Cập nhật số tiền
async function updateRoom(room, btn){
  const tr = btn.closest("tr");
  const amountInput = tr.querySelector("input");
  let amount = amountInput.value.replace(/\./g,'');
  if(isNaN(amount) || amount==='') amount=0;

  const oldText = btn.innerText;
  btn.innerText = "Đang cập nhật...";
  btn.disabled = true;

  await callAPI({action:'update', room, amount});
  btn.innerText = oldText;
  btn.disabled = true;
  loadData();
}
window.updateRoom = updateRoom;

// Đã thanh toán
async function setPaid(room, btn){
  btn.disabled = true;
  await callAPI({action:'paid', room});
  loadData();
}
window.setPaid = setPaid;

// Render bảng
function renderTable(data){
  const tbody = document.querySelector("#roomTable tbody");
  tbody.innerHTML = "";
  if(!data || data.length<=1){
    tbody.innerHTML="<tr><td colspan='5'>Không có dữ liệu</td></tr>";
    return;
  }
  data.slice(1).forEach(row=>{
    const [room, amount, status, , reftime] = [row[0], row[1], row[2], row[3], row[4]]; 
    const tr=document.createElement("tr");
    const formattedAmount = amount ? Number(amount).toLocaleString("vi-VN") : '';
    tr.innerHTML=`
      <td>${room}</td>
      <td><input type="text" value="${formattedAmount}" oninput="enableUpdate(this)" onblur="formatAmountInput(this)" /></td>
      <td class="${status==='Đã thanh toán'?'text-green':(status==='Đang mở'?'text-blue':'text-red')}">${status}</td>
      <td>${reftime||''}</td>
      <td>
        <button class="open-btn" onclick="window.openRoom('${room}', this)">Mở phòng</button>
        <button class="update-btn" onclick="window.updateRoom('${room}', this)" disabled>Cập nhật</button>
        <button class="paid-btn" onclick="window.setPaid('${room}', this)" ${status==='Đã thanh toán'?'disabled':''}>Đã thanh toán</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Load dữ liệu từ sheet ngay khi mở trang
async function loadData(){
  const res=await fetch(API_URL);
  const data=await res.json();
  renderTable(data);
}

// Load dữ liệu khi mở trang
window.onload = loadData;
</script>
</body>
</html>
