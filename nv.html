<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nhân viên Karaoke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    h1 { text-align: center; color: #007bff; }
    #currentTime { text-align:center; font-weight:bold; margin-top:-10px; color:#555; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #007bff; color: white; }
    input[type="text"] { width: 120px; padding: 5px; text-align: right; }
    button { padding: 6px 10px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    .qr { background: #17a2b8; color: white; }
    .paid { background: #28a745; color: white; }
    .status-unpaid { color: red; font-weight: bold; }
    .status-paid { color: green; font-weight: bold; }
    .highlight { background: #d4edda !important; transition: background 2s ease; }
    .qr-box { margin-top:20px; text-align:center; }
    .qr-box img { width: 240px; height: 240px; border:1px solid #ccc; padding:5px; background:#fff; }
    #amountWords { margin-top:10px; font-style:italic; color: green; }
  </style>
</head>
<body>
  <h1>NHÂN VIÊN <br>KARAOKE RITA</h1>
  <p id="currentTime"></p>

  <table>
    <thead>
      <tr>
        <th>Phòng</th>
        <th>Số tiền</th>
        <th>Trạng thái</th>
        <th>Thời gian</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody id="roomTable"></tbody>
  </table>

  <div class="qr-box">
    <h3 id="roomQRName"></h3>
    <img id="qrImage" src="" alt="QR Thanh toán"/>
    <p id="amountWords"></p>
  </div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbyikI5jLJDeLWFEMRk6UVfW2ERp679iA2HkoSG2z_q7aT7SUY2axsFk5e1mUd_Q31Bf/exec";

    const formatNumber = n => n ? Number(n).toLocaleString("vi-VN") : "";

    function numberToWords(n) {
      if (!n || n == 0) return "Không đồng";
      const units = ["","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
      const scales = ["","nghìn","triệu","tỷ"];
      function readTriple(num) {
        let [h,t,o] = String(num).padStart(3,'0').split("").map(Number);
        let s="";
        if(h>0){ s+=units[h]+" trăm"; if(t===0&&o>0)s+=" linh"; }
        if(t>1){ s+=" "+units[t]+" mươi"; if(o===1)s+=" mốt"; else if(o===5)s+=" lăm"; else if(o>0)s+=" "+units[o]; }
        else if(t===1){ s+=" mười"; if(o===1)s+=" một"; else if(o===5)s+=" lăm"; else if(o>0)s+=" "+units[o]; }
        else if(t===0&&o>0&&h===0){ s+=units[o]; } else if(o>0){ s+=" "+units[o]; }
        return s.trim();
      }
      let parts=[], scaleIdx=0;
      while(n>0){
        let chunk=n%1000;
        if(chunk>0){ let words=readTriple(chunk); if(scales[scaleIdx]) words+=" "+scales[scaleIdx]; parts.unshift(words); }
        n=Math.floor(n/1000); scaleIdx++;
      }
      return parts.join(", ")+" đồng";
    }

    async function loadRooms(highlight=null) {
      const res = await fetch(API + "?action=getRooms");
      const data = await res.json();
      const table = document.getElementById("roomTable");
      table.innerHTML = "";

      data.forEach(room => {
        const id = encodeURIComponent(room.name);
        const paid = room.status === "Đã thanh toán";

        const tr = document.createElement("tr");
        tr.id = "row-" + id;
        tr.innerHTML = `
          <td>${room.name}</td>
          <td>${formatNumber(room.amount)}</td>
          <td class="${paid ? 'status-paid':'status-unpaid'}">${room.status}</td>
          <td>${room.refTime || ""}</td>
          <td>
            <button class="qr" onclick="showQR('${room.name}','${room.amount}')">Lấy QR</button>
            <button class="paid" ${paid?"disabled":""} onclick="markPaid('${id}')">Xác nhận thanh toán</button>
          </td>
        `;
        table.appendChild(tr);

        if (highlight === id) {
          tr.classList.add("highlight");
          setTimeout(()=>tr.classList.remove("highlight"),2000);
        }
      });
    }

    function showQR(room, amount) {
      const img = document.getElementById("qrImage");
      const roomQRName = document.getElementById("roomQRName");
      const words = document.getElementById("amountWords");
      roomQRName.innerText = room;
      img.src = `https://img.vietqr.io/image/VCB-9917523946-qr_only.png?amount=${amount}&addInfo=Thank+You+${room}&accountName=HUYNH+PHUONG+TRANG`;
      words.innerText = numberToWords(Number(amount));
    }

    async function markPaid(id) {
      const btn = document.querySelector(`#row-${id} .paid`);
      btn.innerText = "Đang lưu...";
      btn.disabled = true;
      await fetch(`${API}?action=markPaid&room=${id}`);
      await loadRooms(id);
      btn.innerText = "Xác nhận thanh toán";
    }

    function updateClock() {
      const now = new Date();
      const days = ["Chủ Nhật","Thứ Hai","Thứ Ba","Thứ Tư","Thứ Năm","Thứ Sáu","Thứ Bảy"];
      const time = now.toLocaleTimeString("vi-VN", { hour12: false });
      const date = now.toLocaleDateString("vi-VN");
      const dayName = days[now.getDay()];
      document.getElementById("currentTime").innerText = `${time} - ${dayName}, ${date}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    loadRooms();
    setInterval(loadRooms, 15000);
  </script>
</body>
</html>
