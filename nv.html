<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chụp ảnh thanh toán - Karaoke Rita</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin:0; text-align:center; background:#f5f5f5; }
.container { max-width:420px; margin:auto; padding:20px; }
.amount-input { width:80%; font-size:24px; padding:8px; margin-bottom:10px; text-align:center; }
.room-name-qr { font-size:18px; color:#007bff; font-weight:bold; margin-bottom:10px; }
.amount-text { font-size:16px; color:green; margin-bottom:10px; }
.btn { padding:8px 12px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
.btn-qr { background:#007bff; color:white; }
#cameraModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
.modal-content { background:white; padding:10px; border-radius:10px; position:relative; display:flex; flex-direction:column; align-items:center; }
video { border-radius:5px; width:320px; height:240px; }
canvas { display:none; margin-top:10px; border:1px solid #007bff; border-radius:5px; }
.modal-buttons { margin-top:10px; }
</style>
</head>
<body>

<div class="container">
  <h2>Karaoke Rita - Thanh toán</h2>
  <input id="manualAmount" class="amount-input" placeholder="Nhập số tiền" />
  <div class="amount-text" id="amountText"></div>
  <div class="room-name-qr" id="roomNameQR"></div>
  <button id="openCamera" class="btn btn-qr">Chụp ảnh người thanh toán</button>
</div>

<!-- Modal camera -->
<div id="cameraModal">
  <div class="modal-content">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div class="modal-buttons">
      <button id="captureBtn" class="btn btn-qr">Chụp</button>
      <button id="downloadBtn" class="btn" style="display:none;">Tải xuống</button>
      <button id="closeModal" class="btn">Đóng</button>
    </div>
  </div>
</div>

<script>
const openCamera = document.getElementById("openCamera");
const cameraModal = document.getElementById("cameraModal");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const captureBtn = document.getElementById("captureBtn");
const downloadBtn = document.getElementById("downloadBtn");
const closeModal = document.getElementById("closeModal");
const roomNameQR = document.getElementById("roomNameQR");
const manualAmount = document.getElementById("manualAmount");
const amountText = document.getElementById("amountText");

let stream;

// Mở modal và camera sau
openCamera.addEventListener("click", async () => {
  cameraModal.style.display = "flex";
  canvas.style.display = "none";
  downloadBtn.style.display = "none";

  // Mở camera sau nếu có
  try {
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: { exact: "environment" } }, audio: false 
    });
  } catch(e) {
    // nếu không có camera sau thì fallback camera trước
    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
  }
  video.srcObject = stream;
});

// Chụp ảnh
captureBtn.addEventListener("click", () => {
  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Thêm text: phòng, số tiền, thời gian
  ctx.fillStyle = "red";
  ctx.font = "20px Arial";
  const roomName = roomNameQR.textContent || "Chưa có phòng";
  const amountNumber = manualAmount.value || "0";
  const timeStr = new Date().toLocaleString('vi-VN');
  ctx.fillText(`Phòng: ${roomName}`, 10, 30);
  ctx.fillText(`Số tiền: ${amountNumber}`, 10, 60);
  ctx.fillText(`Thời gian: ${timeStr}`, 10, 90);

  canvas.style.display = "block";
  downloadBtn.style.display = "inline-block";
});

// Tải ảnh xuống
downloadBtn.addEventListener("click", () => {
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/png");
  link.download = `ThanhToan_${Date.now()}.png`;
  link.click();
});

// Đóng modal
closeModal.addEventListener("click", () => {
  cameraModal.style.display = "none";
  if(stream){
    stream.getTracks().forEach(track => track.stop());
  }
});
</script>
</body>
</html>
