<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QR Thanh To√°n VietQR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: #f2f2f2;
    }
    h2 { margin-bottom: 10px; }
    #amount {
      font-size: 20px;
      padding: 8px;
      width: 220px;
      text-align: center;
    }
    button {
      font-size: 16px;
      margin: 10px 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
    #qrImage {
      margin: 20px auto;
      display: block;
      max-width: 260px;
    }
    #reader {
      width: 300px;
      margin: 15px auto;
      display: none;
    }
    #amountText {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
    .info {
      text-align: left;
      margin: 20px auto;
      display: inline-block;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 15px;
      line-height: 1.6;
    }
    .info span {
      font-weight: bold;
    }
    .thankyou {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
      color: #008000;
    }
  </style>
</head>
<body>
  <h2>QR Thanh To√°n VietQR</h2>
  <input type="number" id="amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" oninput="updateQR()">
  <br>
  <button onclick="startScan()">üì∑ Qu√©t m√£</button>
  <div id="reader"></div>
  <img id="qrImage" src="" alt="QR s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y">
  <div id="amountText"></div>

  <!-- Th√¥ng tin ng∆∞·ªùi nh·∫≠n -->
  <div class="info">
    <p><span>Ng√¢n h√†ng:</span> Vietcombank (VCB)</p>
    <p><span>S·ªë t√†i kho·∫£n:</span> 9917.523.946</p>
    <p><span>T√™n ng∆∞·ªùi nh·∫≠n:</span> HUYNH PHUONG TRANG</p>
    <p><span>................</span></p>
    <p class="thankyou">XIN C√ÅM ∆†N QU√ù KH√ÅCH ƒê√É S·ª¨ D·ª§NG D·ªäCH V·ª§ T·∫†I RITA</p>
  </div>

  <script>
    function updateQR() {
      let raw = document.getElementById("amount").value.replace(/\D/g,'');
      if (!raw) {
        document.getElementById("qrImage").src = "";
        document.getElementById("amountText").textContent = "";
        return;
      }
      const url = `https://img.vietqr.io/image/VCB-9917523946-qr_only.png?amount=${raw}&addInfo=Thank%20you&accountName=HUYNH+PHUONG+TRANG`;
      document.getElementById("qrImage").src = url;
      document.getElementById("amountText").textContent = toVietnameseText(raw) + " ƒë·ªìng";
    }

    // --- Qu√©t QR ---
    let scanner = null;

    async function startScan() {
      const reader = document.getElementById("reader");
      reader.style.display = "block";

      if (!scanner) {
        scanner = new Html5Qrcode("reader");
      }

      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) {
          alert("Kh√¥ng t√¨m th·∫•y camera!");
          return;
        }

        // ∆∞u ti√™n camera wide/ultra wide
        let cameraId = devices[0].id;
        for (let d of devices) {
          if (/wide|ultra/i.test(d.label)) {
            cameraId = d.id;
            break;
          }
        }

        scanner.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => { handleScanResult(qrCodeMessage); },
          errorMessage => {}
        ).catch(err => {
          console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera:", err);
        });

      } catch (err) {
        console.error("L·ªói khi l·∫•y camera:", err);
        alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera!");
      }
    }

    function handleScanResult(qrCodeMessage) {
      console.log("Scanned:", qrCodeMessage);
      let amount = null;

      try {
        let data = parseVietQR(qrCodeMessage);
        if (data["54"]) amount = data["54"];
      } catch(e) {
        console.warn("Kh√¥ng parse ƒë∆∞·ª£c EMV:", e);
      }

      if (!amount && /^\d+$/.test(qrCodeMessage)) {
        amount = qrCodeMessage;
      }

      if (amount) {
        document.getElementById("amount").value = amount;
        updateQR();
      } else {
        alert("QR kh√¥ng ch·ª©a s·ªë ti·ªÅn h·ª£p l·ªá!");
      }

      stopScan();
    }

    function stopScan() {
      if (scanner) {
        scanner.stop().then(() => {
          document.getElementById("reader").style.display = "none";
        }).catch(err => console.error("D·ª´ng camera l·ªói:", err));
      }
    }

    // --- parse QR chu·∫©n VietQR/EMV ---
    function parseVietQR(data) {
      let i = 0, res = {};
      while (i < data.length) {
        let id = data.substr(i,2); i+=2;
        let len = parseInt(data.substr(i,2)); i+=2;
        let val = data.substr(i,len); i+=len;
        res[id] = val;
      }
      return res;
    }

    // --- Chuy·ªÉn s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát ---
    function toVietnameseText(number) {
      const dv = ["","m·ªôt","hai","ba","b·ªën","nƒÉm","s√°u","b·∫£y","t√°m","ch√≠n"];
      function read3(num){
        let str = "";
        let tram = Math.floor(num/100);
        let chuc = Math.floor((num%100)/10);
        let donvi = num%10;
        if(tram>0){ str+=dv[tram]+" trƒÉm "; if(chuc==0&&donvi>0) str+="l·∫ª "; }
        if(chuc>1){ str+=dv[chuc]+" m∆∞∆°i "; if(donvi==1) str+="m·ªët "; else if(donvi==5) str+="lƒÉm "; else if(donvi>0) str+=dv[donvi]+" "; }
        else if(chuc==1){ str+="m∆∞·ªùi "; if(donvi==5) str+="lƒÉm "; else if(donvi>0) str+=dv[donvi]+" "; }
        else if(chuc==0&&donvi>0) str+=dv[donvi]+" ";
        return str;
      }
      if(number==0) return "kh√¥ng";
      let i=0, arr=[];
      const units=["","ngh√¨n","tri·ªáu","t·ª∑"];
      while(number>0){
        let num=number%1000;
        if(num>0) arr.unshift(read3(num)+units[i]);
        number=Math.floor(number/1000);
        i++;
      }
      return arr.join(" ").trim();
    }
  </script>
</body>
</html>
