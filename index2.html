<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QR Thanh Toán VietQR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: #f2f2f2;
    }
    h2 { margin-bottom: 10px; }
    #amount {
      font-size: 20px;
      padding: 8px;
      width: 220px;
      text-align: center;
    }
    button {
      font-size: 16px;
      margin: 10px 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
    #qrImage {
      margin: 20px auto;
      display: block;
      max-width: 260px;
    }
    #reader {
      width: 300px;
      margin: 15px auto;
      display: none;
    }
    #amountText {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>QR Thanh Toán VietQR</h2>
  <input type="number" id="amount" placeholder="Nhập số tiền" oninput="updateQR()">
  <br>
  <button onclick="startScan()">📷 Quét mã</button>
  <div id="reader"></div>
  <img id="qrImage" src="" alt="QR sẽ hiển thị ở đây">
  <div id="amountText"></div>

  <script>
    function updateQR() {
      let raw = document.getElementById("amount").value.replace(/\D/g,'');
      if (!raw) {
        document.getElementById("qrImage").src = "";
        document.getElementById("amountText").textContent = "";
        return;
      }
      const url = `https://img.vietqr.io/image/VCB-9917523946-qr_only.png?amount=${raw}&addInfo=Thank%20you&accountName=HUYNH+PHUONG+TRANG`;
      document.getElementById("qrImage").src = url;
      document.getElementById("amountText").textContent = toVietnameseText(raw) + " đồng";
    }

    // --- Quét QR ---
    let scanner = null;

    async function startScan() {
      const reader = document.getElementById("reader");
      reader.style.display = "block";

      if (!scanner) {
        scanner = new Html5Qrcode("reader");
      }

      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) {
          alert("Không tìm thấy camera!");
          return;
        }

        // ưu tiên camera wide/ultra wide
        let cameraId = devices[0].id;
        for (let d of devices) {
          if (/wide|ultra/i.test(d.label)) {
            cameraId = d.id;
            break;
          }
        }

        scanner.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => { handleScanResult(qrCodeMessage); },
          errorMessage => {}
        ).catch(err => {
          console.error("Không mở được camera:", err);
        });

      } catch (err) {
        console.error("Lỗi khi lấy camera:", err);
        alert("Không mở được camera!");
      }
    }

    function handleScanResult(qrCodeMessage) {
      console.log("Scanned:", qrCodeMessage);
      let amount = null;

      try {
        let data = parseVietQR(qrCodeMessage);
        if (data["54"]) amount = data["54"];
      } catch(e) {
        console.warn("Không parse được EMV:", e);
      }

      if (!amount && /^\d+$/.test(qrCodeMessage)) {
        amount = qrCodeMessage;
      }

      if (amount) {
        document.getElementById("amount").value = amount;
        updateQR();
      } else {
        alert("QR không chứa số tiền hợp lệ!");
      }

      stopScan();
    }

    function stopScan() {
      if (scanner) {
        scanner.stop().then(() => {
          document.getElementById("reader").style.display = "none";
        }).catch(err => console.error("Dừng camera lỗi:", err));
      }
    }

    // --- parse QR chuẩn VietQR/EMV ---
    function parseVietQR(data) {
      let i = 0, res = {};
      while (i < data.length) {
        let id = data.substr(i,2); i+=2;
        let len = parseInt(data.substr(i,2)); i+=2;
        let val = data.substr(i,len); i+=len;
        res[id] = val;
      }
      return res;
    }

    // --- Chuyển số thành chữ tiếng Việt ---
    function toVietnameseText(number) {
      const dv = ["","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
      function read3(num){
        let str = "";
        let tram = Math.floor(num/100);
        let chuc = Math.floor((num%100)/10);
        let donvi = num%10;
        if(tram>0){ str+=dv[tram]+" trăm "; if(chuc==0&&donvi>0) str+="lẻ "; }
        if(chuc>1){ str+=dv[chuc]+" mươi "; if(donvi==1) str+="mốt "; else if(donvi==5) str+="lăm "; else if(donvi>0) str+=dv[donvi]+" "; }
        else if(chuc==1){ str+="mười "; if(donvi==5) str+="lăm "; else if(donvi>0) str+=dv[donvi]+" "; }
        else if(chuc==0&&donvi>0) str+=dv[donvi]+" ";
        return str;
      }
      if(number==0) return "không";
      let i=0, arr=[];
      const units=["","nghìn","triệu","tỷ"];
      while(number>0){
        let num=number%1000;
        if(num>0) arr.unshift(read3(num)+units[i]);
        number=Math.floor(number/1000);
        i++;
      }
      return arr.join(" ").trim();
    }
  </script>
</body>
</html>
