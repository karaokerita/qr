<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QR Thanh To√°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .container {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 16px;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    input {
      padding: 10px;
      font-size: 18px;
      width: 80%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #qrImage {
      display: block;
      margin: 20px auto;
    }
    #amountText {
      margin-top: 10px;
      font-weight: bold;
    }
    #reader {
      width: 300px;
      margin: 20px auto;
      display: none;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>QR Thanh To√°n</h2>
    <input type="number" id="amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn (VD: 150000)" oninput="formatAndUpdateQR(this)" autocomplete="off">
    <div id="amountText"></div>
    <img id="qrImage" src="" alt="QR Thanh to√°n" width="250">
    <br>
    <button onclick="startScan()">üì∑ Qu√©t QR l·∫•y s·ªë ti·ªÅn</button>
    <div id="reader"></div>
  </div>

  <script>
    let scanner = null;
    let currentCameraId = null;

    window.onload = () => {
      document.getElementById("amount").value = "";
      document.getElementById("qrImage").src = "";
      document.getElementById("amountText").innerText = "";
    };

    // Sinh m√£ QR thanh to√°n (demo)
    function formatAndUpdateQR(input) {
      let value = input.value.replace(/\D/g, "");
      input.value = value;

      if (!value) {
        document.getElementById("qrImage").src = "";
        document.getElementById("amountText").innerText = "";
        return;
      }

      let qrData = "https://img.vietqr.io/image/970422-00000000000000-compact2.png?amount=" + value;
      document.getElementById("qrImage").src = qrData;

      document.getElementById("amountText").innerText = toVietnameseText(value) + " ƒë·ªìng";
    }

    // ƒê·ªçc s·ªë ti·ªÅn t·ª´ QR VietQR (chu·∫©n EMV)
    function parseVietQR(qrString) {
      let i = 0;
      let result = {};
      while (i < qrString.length) {
        let tag = qrString.substr(i, 2);
        let length = parseInt(qrString.substr(i + 2, 2), 10);
        let value = qrString.substr(i + 4, length);
        result[tag] = value;
        i += 4 + length;
      }
      return result;
    }

    async function startScan() {
      const reader = document.getElementById("reader");
      reader.style.display = "block";

      if (!scanner) {
        scanner = new Html5Qrcode("reader");
      }

      if (!currentCameraId) {
        try {
          const cameras = await Html5Qrcode.getCameras();
          console.log("Danh s√°ch camera:", cameras);

          if (cameras && cameras.length) {
            let wideCam = cameras.find(cam =>
              cam.label.toLowerCase().includes("wide")
            );
            currentCameraId = wideCam ? wideCam.id : cameras[0].id;
          }
        } catch (err) {
          console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c camera:", err);
        }
      }

      scanner.start(
        currentCameraId || { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => { handleScanResult(qrCodeMessage); },
        errorMessage => {}
      ).catch(err => {
        console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera: ", err);
      });
    }

    function handleScanResult(qrCodeMessage) {
      console.log("Scanned:", qrCodeMessage);

      let amount = null;
      try {
        let data = parseVietQR(qrCodeMessage);
        if (data["54"]) amount = data["54"];
      } catch(e) {
        console.warn("Kh√¥ng parse ƒë∆∞·ª£c EMV:", e);
      }

      if (!amount && /^\d+$/.test(qrCodeMessage)) {
        amount = qrCodeMessage;
      }

      if (amount) {
        document.getElementById("amount").value = amount;
        formatAndUpdateQR(document.getElementById("amount"));
      } else {
        alert("QR kh√¥ng ch·ª©a s·ªë ti·ªÅn h·ª£p l·ªá!");
      }

      stopScan();
    }

    function stopScan() {
      if (scanner) {
        scanner.stop().then(() => {
          document.getElementById("reader").style.display = "none";
        }).catch(err => console.error("D·ª´ng camera l·ªói:", err));
      }
    }

    // Chuy·ªÉn s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát
    function toVietnameseText(number) {
      const ChuSo = ["kh√¥ng","m·ªôt","hai","ba","b·ªën","nƒÉm","s√°u","b·∫£y","t√°m","ch√≠n"];
      const Tien = ["", "ngh√¨n", "tri·ªáu", "t·ª∑"];
      let num = parseInt(number, 10);
      if (isNaN(num)) return "";

      function read3(number) {
        let hundred = Math.floor(number/100);
        let ten = Math.floor((number%100)/10);
        let unit = number%10;
        let str = "";
        if (hundred > 0) {
          str += ChuSo[hundred] + " trƒÉm";
          if (ten === 0 && unit > 0) str += " l·∫ª";
        }
        if (ten > 1) {
          str += " " + ChuSo[ten] + " m∆∞∆°i";
          if (unit === 1) str += " m·ªët";
          else if (unit === 5) str += " lƒÉm";
          else if (unit > 0) str += " " + ChuSo[unit];
        } else if (ten === 1) {
          str += " m∆∞·ªùi";
          if (unit === 1) str += " m·ªôt";
          else if (unit === 5) str += " lƒÉm";
          else if (unit > 0) str += " " + ChuSo[unit];
        } else if (unit > 0) {
          str += " " + ChuSo[unit];
        }
        return str.trim();
      }

      let i = 0, result = "";
      while (num > 0) {
        let block = num % 1000;
        if (block > 0) result = read3(block) + " " + Tien[i] + " " + result;
        num = Math.floor(num/1000);
        i++;
      }
      return result.trim();
    }
  </script>
</body>
</html>
