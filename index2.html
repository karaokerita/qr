<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QR Thanh ToÃ¡n VietQR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: #f2f2f2;
    }
    h2 { margin-bottom: 10px; }
    #amount {
      font-size: 20px;
      padding: 8px;
      width: 220px;
      text-align: center;
    }
    button {
      font-size: 16px;
      margin: 10px 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
    #qrImage {
      margin: 20px auto;
      display: block;
      max-width: 260px;
    }
    #reader {
      width: 300px;
      margin: 15px auto;
      display: none;
    }
    #amountText {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>QR Thanh ToÃ¡n VietQR</h2>
  <input type="number" id="amount" placeholder="Nháº­p sá»‘ tiá»n" oninput="updateQR()">
  <br>
  <button onclick="startScan()">ðŸ“· QuÃ©t mÃ£</button>
  <div id="reader"></div>
  <img id="qrImage" src="" alt="QR sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y">
  <div id="amountText"></div>

  <script>
    function updateQR() {
      let raw = document.getElementById("amount").value.replace(/\D/g,'');
      if (!raw) {
        document.getElementById("qrImage").src = "";
        document.getElementById("amountText").textContent = "";
        return;
      }
      const url = `https://img.vietqr.io/image/VCB-9917523946-qr_only.png?amount=${raw}&addInfo=Thank%20you&accountName=HUYNH+PHUONG+TRANG`;
      document.getElementById("qrImage").src = url;
      document.getElementById("amountText").textContent = toVietnameseText(raw) + " Ä‘á»“ng";
    }

    // --- QuÃ©t QR ---
    let scanner = null;

    async function startScan() {
      const reader = document.getElementById("reader");
      reader.style.display = "block";

      if (!scanner) {
        scanner = new Html5Qrcode("reader");
      }

      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) {
          alert("KhÃ´ng tÃ¬m tháº¥y camera!");
          return;
        }

        // Æ°u tiÃªn camera wide/ultra wide
        let cameraId = devices[0].id;
        for (let d of devices) {
          if (/wide|ultra/i.test(d.label)) {
            cameraId = d.id;
            break;
          }
        }

        scanner.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => { handleScanResult(qrCodeMessage); },
          errorMessage => {}
        ).catch(err => {
          console.error("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera:", err);
        });

      } catch (err) {
        console.error("Lá»—i khi láº¥y camera:", err);
        alert("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera!");
      }
    }

    function handleScanResult(qrCodeMessage) {
      console.log("Scanned:", qrCodeMessage);
      let amount = null;

      try {
        let data = parseVietQR(qrCodeMessage);
        if (data["54"]) amount = data["54"];
      } catch(e) {
        console.warn("KhÃ´ng parse Ä‘Æ°á»£c EMV:", e);
      }

      if (!amount && /^\d+$/.test(qrCodeMessage)) {
        amount = qrCodeMessage;
      }

      if (amount) {
        document.getElementById("amount").value = amount;
        updateQR();
      } else {
        alert("QR khÃ´ng chá»©a sá»‘ tiá»n há»£p lá»‡!");
      }

      stopScan();
    }

    function stopScan() {
      if (scanner) {
        scanner.stop().then(() => {
          document.getElementById("reader").style.display = "none";
        }).catch(err => console.error("Dá»«ng camera lá»—i:", err));
      }
    }

    // --- parse QR chuáº©n VietQR/EMV ---
    function parseVietQR(data) {
      let i = 0, res = {};
      while (i < data.length) {
        let id = data.substr(i,2); i+=2;
        let len = parseInt(data.substr(i,2)); i+=2;
        let val = data.substr(i,len); i+=len;
        res[id] = val;
      }
      return res;
    }

    // --- Chuyá»ƒn sá»‘ thÃ nh chá»¯ tiáº¿ng Viá»‡t ---
    function toVietnameseText(number) {
      const dv = ["","má»™t","hai","ba","bá»‘n","nÄƒm","sÃ¡u","báº£y","tÃ¡m","chÃ­n"];
      function read3(num){
        let str = "";
        let tram = Math.floor(num/100);
        let chuc = Math.floor((num%100)/10);
        let donvi = num%10;
        if(tram>0){ str+=dv[tram]+" trÄƒm "; if(chuc==0&&donvi>0) str+="láº» "; }
        if(chuc>1){ str+=dv[chuc]+" mÆ°Æ¡i "; if(donvi==1) str+="má»‘t "; else if(donvi==5) str+="lÄƒm "; else if(donvi>0) str+=dv[donvi]+" "; }
        else if(chuc==1){ str+="mÆ°á»i "; if(donvi==5) str+="lÄƒm "; else if(donvi>0) str+=dv[donvi]+" "; }
        else if(chuc==0&&donvi>0) str+=dv[donvi]+" ";
        return str;
      }
      if(number==0) return "khÃ´ng";
      let i=0, arr=[];
      const units=["","nghÃ¬n","triá»‡u","tá»·"];
      while(number>0){
        let num=number%1000;
        if(num>0) arr.unshift(read3(num)+units[i]);
        number=Math.floor(number/1000);
        i++;
      }
      return arr.join(" ").trim();
    }
  </script>
</body>
</html>
