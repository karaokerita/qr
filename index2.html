<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QR Thanh Toán - Karaoke Rita</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#fff; color:#000; text-align:center; }
    h2 { margin-top:12px; margin-bottom:8px; font-size:24px; color:#007bff; }   /* xanh dương */
    h3 { margin:10px 0 14px; font-size:22px; color:#28a745; }                  /* xanh lá */
    .address { font-size:14px; margin-bottom:18px; }
    .container { max-width:420px; margin:auto; padding:20px; }

    .amount-input { font-size:20px; padding:10px; width:80%; text-align:center; margin-bottom:8px; }
    .error { color:#d00; font-size:14px; display:none; margin:8px 0; }

    .btn { display:inline-block; padding:10px 20px; margin:8px 0; border:none; border-radius:8px; background:#007bff; color:#fff; font-size:16px; cursor:pointer; }
    .btn:hover { background:#0056b3; }

    .qr-box img { width:250px; height:250px; margin:15px 0; }

    #amountText { font-size:16px; margin-top:5px; font-weight:bold; }
    #amountWords { font-size:14px; margin-top:6px; color:#444; font-style:italic; }

    .info { text-align:left; font-size:14px; margin-top:15px; }
    .info p { margin:4px 0; } .info span{ font-weight:bold; }

    .thanks {
      margin-top:18px;
      font-weight:bold;
      text-align:center;
      color:#28a745;            /* xanh lá */
      line-height:1.6;          /* giãn cách 2 dòng */
      letter-spacing:0.2px;
    }

    /* Modal camera */
    .modal { display:none; position:fixed; z-index:999; inset:0; background:rgba(0,0,0,0.7); }
    .modal-content { position:relative; margin:5% auto; width:92%; max-width:420px; background:#fff; border-radius:10px; padding:10px; }
    .close-btn { position:absolute; top:6px; right:10px; font-size:18px; cursor:pointer; color:#d00; }
    #reader { width:100%; }
    .hint { font-size:12px; color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>QUÉT MÃ ĐỂ THANH TOÁN</h2>
    <h3>KARAOKE RITA</h3>
    <div class="address">8 Lý Thường Kiệt, Đức Trọng</div>

    <input id="amount" class="amount-input" type="text" placeholder="Nhập số tiền" />
    <div id="errorMsg" class="error">Quét không thành công</div>

    <button class="btn" onclick="openScanner()">Quét mã</button>

    <div class="qr-box">
      <img id="qrImage" src="" alt="QR Thanh toán" />
    </div>
    <div id="amountText"></div>
    <div id="amountWords"></div>

    <div class="info">
      <p><span>Ngân hàng:</span> Vietcombank (VCB)</p>
      <p><span>Số tài khoản:</span> 9917.523.946</p>
      <p><span>Tên người nhận:</span> HUYNH PHUONG TRANG</p>
    </div>

    <div class="thanks">
      XIN CÁM ƠN QUÝ KHÁCH<br>
      ĐÃ SỬ DỤNG DỊCH VỤ TẠI RITA
    </div>
  </div>

  <!-- Modal Camera -->
  <div id="scanModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeScanner()">&times;</span>
      <div id="reader"></div>
      <div class="hint">Mẹo: đưa mã vào giữa khung, chạm vào video để máy lấy nét nếu thiết bị hỗ trợ.</div>
    </div>
  </div>

<script>
  const amountInput = document.getElementById("amount");
  const errorMsg = document.getElementById("errorMsg");
  const qrImg = document.getElementById("qrImage");
  const amountText = document.getElementById("amountText");
  const amountWords = document.getElementById("amountWords");

  // Nhập số tiền thủ công -> tự tạo QR
  amountInput.addEventListener("input", function () {
    errorMsg.style.display = "none";
    let val = this.value.replace(/\D/g, "");
    if (val) {
      this.value = Number(val).toLocaleString("vi-VN");
      updateQR(val);
    } else {
      this.value = "";
      clearQR();
    }
  });

  function updateQR(val) {
    const url = `https://img.vietqr.io/image/VCB-9917523946-qr_only.png?amount=${val}&addInfo=Thank you&accountName=HUYNH+PHUONG+TRANG`;
    qrImg.src = url;
    amountText.textContent = Number(val).toLocaleString("vi-VN") + " đồng";
    amountWords.textContent = numberToWordsGrouped(Number(val)) + " đồng";
  }
  function clearQR() {
    qrImg.src = "";
    amountText.textContent = "";
    amountWords.textContent = "";
  }

  // ====== Scanner ======
  let html5QrCode;
  let handled = false;

  function openScanner() {
    amountInput.value = "";
    clearQR();
    errorMsg.style.display = "none";
    handled = false;

    document.getElementById("scanModal").style.display = "block";
    html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
      if (!devices || !devices.length) return;

      // Ưu tiên camera góc rộng / sau / 0.5x nếu có
      const pick = devices.find(d => /wide|ultra|0\.5|back|rear/i.test(d.label))?.id || devices[0].id;

      html5QrCode.start(
        pick,
        { fps: 12, qrbox: 260, videoConstraints: { facingMode: "environment" } },
        onScanSuccess,
        () => {}
      ).then(enableTapToFocus).catch(console.error);
    }).catch(console.error);
  }

  function closeScanner() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{});
    }
    document.getElementById("scanModal").style.display = "none";
  }

  function onScanSuccess(qrMessage) {
    if (handled) return; // tránh xử lý 2 lần
    const amt = extractAmountFromQR(qrMessage);
    if (amt && !isNaN(amt) && amt > 0) {
      handled = true;
      amountInput.value = Number(amt).toLocaleString("vi-VN");
      updateQR(amt);
      closeScanner();
    } else {
      errorMsg.style.display = "block"; // giữ camera mở để quét lại
    }
  }

  // ====== EMV parser CHUẨN: đọc tag 54 theo độ dài ======
  function extractAmountFromQR(qrText) {
    if (!qrText) return null;

    // 1) URL có amount=...
    const m = qrText.match(/(?:^|[?&])amount=(\d+)/i);
    if (m) return parseInt(m[1], 10);

    // 2) EMVCo TLV: TT LL VALUE ...
    const s = qrText.trim();
    let i = 0;
    while (i + 4 <= s.length) {
      const tag = s.substr(i, 2);
      const lenStr = s.substr(i + 2, 2);
      if (!/^\d{2}$/.test(lenStr)) break;
      const len = parseInt(lenStr, 10);
      const start = i + 4;
      const end = start + len;
      if (end > s.length) break;

      const value = s.substring(start, end);
      if (tag === "54") {
        // Hỗ trợ "100000" hoặc "100000.00"
        const normalized = value.replace(",", ".").trim();
        const f = parseFloat(normalized);
        if (!isNaN(f)) return Math.round(f);    // VND: làm tròn về số nguyên
        const digits = value.replace(/[^\d]/g, "");
        if (digits) return parseInt(digits, 10);
        return null;
      }
      i = end;
    }
    return null;
  }

  // (tuỳ chọn) chạm vào video để gợi ý thiết bị lấy nét, nếu hỗ trợ
  function enableTapToFocus() {
    setTimeout(() => {
      const video = document.querySelector("#reader video");
      if (!video || !video.srcObject) return;
      video.addEventListener("click", async () => {
        try {
          const track = video.srcObject.getVideoTracks()[0];
          const caps = track.getCapabilities?.() || {};
          if (caps.focusMode && caps.focusMode.length) {
            await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
          }
        } catch {}
      });
    }, 400);
  }

  // ====== Chuyển số thành chữ, có dấu phẩy giữa nhóm (tỷ, triệu, nghìn) ======
  function numberToWordsGrouped(num) {
    if (!Number.isFinite(num) || num === 0) return "không";
    const units = ["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    const scales = ["", "nghìn", "triệu", "tỷ"];

    function read3(n, full) {
      const tr = Math.floor(n/100), ch = Math.floor((n%100)/10), dv = n%10;
      let s = "";
      if (full || tr>0) { s += units[tr] + " trăm"; if (ch===0 && dv>0) s += " lẻ"; }
      if (ch>1)       { s += (s?" ":"") + units[ch] + " mươi" + (dv===1?" mốt": dv===5?" lăm": dv>0?" "+units[dv]:""); }
      else if (ch===1){ s += (s?" ":"") + "mười" + (dv===5?" lăm": dv>0?" "+units[dv]:""); }
      else if (dv>0)  { s += (s?" ":"") + units[dv]; }
      return s.trim();
    }

    let segs = [], i = 0, full = false;
    while (num > 0) {
      const block = num % 1000;
      if (block) {
        let part = read3(block, full);
        if (scales[i]) part += " " + scales[i];
        segs.unshift(part);
      }
      num = Math.floor(num/1000);
      i++; full = true;
    }
    // nối các nhóm bằng dấu phẩy
    return segs.join(", ").replace(/\s+,/g, ",").trim();
  }
</script>
</body>
</html>
