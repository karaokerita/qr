<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>QR Thanh Toán - Karaoke Rita</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { 
  margin:0; 
  font-family: Arial, sans-serif; 
  background: url('background.jpg') no-repeat center center fixed; 
  background-size: cover;
  color:#000; 
  text-align:center; 
}

.container { 
  max-width:420px; 
  margin: auto; 
  padding:20px; 
  transform: scale(0.8);         /* thu nhỏ 80% */
  transform-origin: top center;   /* căn giữa theo trục ngang */
  background: rgba(255,255,255,0.8); /* nền hơi trong suốt */
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

h2 { margin-top:12px; margin-bottom:8px; font-size:24px; color:#007bff; }
h3 { margin:10px 0 14px; font-size:22px; color:#28a745; }
.address { font-size:14px; margin-bottom:18px; }

.amount-input { font-size:20px; padding:10px; width:80%; text-align:center; margin-bottom:8px; }
.error { color:#d00; font-size:14px; display:none; margin:8px 0; }

.btn { display:inline-block; padding:10px 20px; margin:8px 0; border:none; border-radius:8px; background:#007bff; color:#fff; font-size:16px; cursor:pointer; }
.btn:hover { background:#0056b3; }

.qr-box img { width:250px; height:250px; margin:15px 0; }

#amountText { font-size:18px; margin-top:5px; font-weight:bold;color:green; }

.info { text-align:left; font-size:14px; margin-top:15px; }
.info p { margin:4px 0; } 
.info span{ font-weight:bold; }

.thanks {
  margin-top:18px;
  font-weight:bold;
  text-align:center;
  color:#28a745;
  line-height:1.6;
  letter-spacing:0.2px;
}

/* Modal camera */
.modal { display:none; position:fixed; z-index:999; inset:0; background:rgba(0,0,0,0.7); }
.modal-content { position:relative; margin:5% auto; width:92%; max-width:420px; background:#fff; border-radius:10px; padding:10px; }
.close-btn { position:absolute; top:6px; right:10px; font-size:18px; cursor:pointer; color:#d00; }
#reader { width:100%; }
.hint { font-size:12px; color:#555; margin-top:6px; }
</style>
</head>
<body>

<div class="container">
  <h2>QUÉT MÃ ĐỂ THANH TOÁN</h2>
  <h3>KARAOKE RITA</h3>
  <div class="address">8 Lý Thường Kiệt, Đức Trọng</div>

  <input id="amount" class="amount-input" type="text" placeholder="Nhập số tiền" />
  <div id="errorMsg" class="error">Quét không thành công</div>

  <button class="btn" onclick="openScanner()">Quét mã</button>

  <div class="qr-box">
    <img id="qrImage" src="" alt="QR Thanh toán" />
  </div>
  <div id="amountText"></div>

  <div class="info">
    <p><span>Ngân hàng:</span> Vietcombank (VCB)</p>
    <p><span>Số tài khoản:</span> 9917.523.946</p>
    <p><span>Tên người nhận:</span> HUYNH PHUONG TRANG</p>
  </div>

  <div class="thanks">
    XIN CÁM ƠN QUÝ KHÁCH<br>
    ĐÃ SỬ DỤNG DỊCH VỤ TẠI RITA
  </div>
</div>

<!-- Modal Camera -->
<div id="scanModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeScanner()">&times;</span>
    <div id="reader"></div>
    <div class="hint">Mẹo: đưa mã vào giữa khung, chạm vào video để máy lấy nét nếu thiết bị hỗ trợ.</div>
  </div>
</div>

<script>
const amountInput = document.getElementById("amount");
const qrImg = document.getElementById("qrImage");
const amountText = document.getElementById("amountText");
const errorMsg = document.getElementById("errorMsg");

// Chuyển số thành chữ tiếng Việt
function readTriple(num){
  const units=["","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
  let [hundreds,tens,ones]=String(num).padStart(3,'0').split("").map(Number);
  let s="";
  if(hundreds>0){ s+=units[hundreds]+" trăm"; if(tens===0&&ones>0)s+=" linh"; }
  if(tens>1){ s+=" "+units[tens]+" mươi"; if(ones===1)s+=" mốt"; else if(ones===5)s+=" lăm"; else if(ones>0)s+=" "+units[ones]; }
  else if(tens===1){ s+=" mười"; if(ones===1)s+=" một"; else if(ones===5)s+=" lăm"; else if(ones>0)s+=" "+units[ones]; }
  else if(tens===0&&ones>0&&hundreds===0){ s+=units[ones]; }
  else if(ones>0){ s+=" "+units[ones]; }
  return s.trim();
}

function numberToWords(n){
  if(!n||n===0) return "không đồng";
  const scales=["","nghìn","triệu","tỷ"];
  let parts=[], scaleIdx=0;
  while(n>0){
    let chunk=n%1000;
    if(chunk>0){ let words=readTriple(chunk); if(scales[scaleIdx]) words+=" "+scales[scaleIdx]; parts.unshift(words); }
    n=Math.floor(n/1000);
    scaleIdx++;
  }
  return parts.join(", ").replace(/ ,/g,",").replace(/\s+/g," ").trim()+" đồng";
}

// Tạo QR và hiển thị chữ
function updateQR(val){
  const url=`https://img.vietqr.io/image/VCB-9917523946-qr_only.png?amount=${val}&addInfo=Thank+you&accountName=HUYNH+PHUONG+TRANG`;
  qrImg.src=url;
  amountText.textContent=numberToWords(Number(val));
}

function clearQR(){ qrImg.src=""; amountText.textContent=""; }

// Input số tiền thủ công
amountInput.addEventListener("input", function(){
  errorMsg.style.display="none";
  let val=this.value.replace(/\D/g,"");
  if(val){ this.value=Number(val).toLocaleString("vi-VN"); updateQR(val); }
  else { this.value=""; clearQR(); }
});

// Scanner QR
let html5QrCode; let handled=false;
function openScanner(){
  amountInput.value=""; clearQR(); errorMsg.style.display="none"; handled=false;
  document.getElementById("scanModal").style.display="block";
  html5QrCode=new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(devices=>{
    if(!devices||!devices.length) return;
    const pick=devices.find(d=>/wide|ultra|0\.5|back|rear/i.test(d.label))?.id || devices[0].id;
    html5QrCode.start(pick,{fps:12,qrbox:260,videoConstraints:{facingMode:"environment"}},onScanSuccess,()=>{}).catch(console.error);
  }).catch(console.error);
}

function closeScanner(){ if(html5QrCode){ html5QrCode.stop().then(()=>html5QrCode.clear()).catch(()=>{}); } document.getElementById("scanModal").style.display="none"; }

function onScanSuccess(qrMessage){
  if(handled) return;
  const amt=extractAmountFromQR(qrMessage);
  if(amt && !isNaN(amt) && amt>0){
    handled=true;
    amountInput.value=Number(amt).toLocaleString("vi-VN");
    updateQR(amt);
    closeScanner();
  } else { errorMsg.style.display="block"; }
}

function extractAmountFromQR(qrText){
  if(!qrText) return null;
  const m=qrText.match(/(?:^|[?&])amount=(\d+)/i);
  if(m) return parseInt(m[1],10);
  const s=qrText.trim(); let i=0;
  while(i+4<=s.length){
    const tag=s.substr(i,2); const lenStr=s.substr(i+2,2);
    if(!/^\d{2}$/.test(lenStr)) break;
    const len=parseInt(lenStr,10); const start=i+4; const end=start+len;
    if(end>s.length) break;
    const value=s.substring(start,end);
    if(tag==="54"){
      const normalized=value.replace(",",".").trim(); const f=parseFloat(normalized);
      if(!isNaN(f)) return Math.round(f);
      const digits=value.replace(/[^\d]/g,""); if(digits) return parseInt(digits,10);
      return null;
    }
    i=end;
  }
  return null;
}

// Optional: chạm vào video để lấy nét
function enableTapToFocus(){
  setTimeout(()=>{
    const video=document.querySelector("#reader video");
    if(!video||!video.srcObject) return;
    video.addEventListener("click",async()=>{
      try{
        const track=video.srcObject.getVideoTracks()[0]; const caps=track.getCapabilities?.()||{};
        if(caps.focusMode&&caps.focusMode.length){ await track.applyConstraints({advanced:[{focusMode:"continuous"}]}); }
      }catch{}
    });
  },400);
}
</script>
</body>
</html>
